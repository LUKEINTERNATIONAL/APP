<script type="text/javascript" src="/assets/js/jquery.min.js"></script>
<script type="text/javascript" src="/public/touchscreentoolkit/lib/javascripts/touchScreenToolkit.js" defer="true"></script>
<script type="text/javascript" src="/assets/js/moment.js"></script>
<script type="text/javascript" src="/assets/js/alertifyjs/alertify.js"></script>
<script type="text/javascript" src="/assets/js/does_connection_exist.js"></script>

<link rel="stylesheet" href="/assets/css/alertifyjs/css/alertify.css" type="text/css">

<style>
  #clearButton { display: none; }
#cancelButton { display: none; }
.loader {
        position: absolute;
        display: none;
        top: 30%;
        left: 40%;
        border: 16px solid #f3f3f3; /* Light grey */
        border-top: 16px solid #3498db; /* Blue */
        border-radius: 50%;
        width: 120px;
        height: 120px;
        animation: spin 2s linear infinite;
        z-index: 9999999999999;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
#activeFileNumbers {
        width: 90%;
        padding: 2%;
        margin: 0 auto;
      }

      .activeFileNumber {
        background-color: white;
        display: inline-block;
        width: 27%;
        margin: 1%;
        padding: 2%;
        border-radius: 2px;
        box-shadow: 0 1px 1px black;
      }

      .activeFileNumber:hover {
        cursor: pointer;
        box-shadow: 0 6px 6px brown;
      }

      .activeFileNumber h3 {
        font-family: Ubuntu;
        color: crimson;
      }

      .activeFileNumber p {
        font-family: Ubuntu;
        font-weight: 100;
        text-align: justify;
        word-spacing: .2em;
      }

      h3 {
        font-size: 1.2em;
      }

      #footer {
        width: 95%;
        margin: 0 auto;
        padding-top: 2%;
      }

      button {
        color: white;
        border-radius: 6px;
        font-size: 1.5em;
        padding: 1%;
      }

      button:hover {
        cursor: pointer;
      }

      .button.red {
        float: left;
      }

      .button.blue {
        float: right;
      }
</style>

<script>
  function init() {
    var f = document.getElementById('inputFrame' + tstCurrentPage);
    f.style = 'width: 96%; height: 90%; overflow: scroll';

    document.getElementById('nextButton').style.display = 'none';

    var fileNumbers = document.createElement('div');
    fileNumbers.setAttribute('id', 'activeFileNumbers');
    f.appendChild(fileNumbers)
    fetchFileNumber(fetchArgumentFromUrlString('patient_id'));
  }
</script>


<body id="mateme">
  <div id="container">
    <div id="content">
      <form>
        <input type="text" name="filing-numbers" tt_onLoad="__$('keyboard').style.display = 'none'; init();"
          tt_pageStyleClass="NoControls" helpText="Filing numbers" optional="true" />

      </form>

            <div class="loader"></div>
    </div>
  </div>

  <script>
    var apiUrl = 'http://' + sessionStorage.getItem('apiURL') + ':' + sessionStorage.getItem('apiPort') + '/api/v1';
    var PAGE_SIZE = 6;
    var paginationPage = 0;

    function populatePageWithActiveFileNumbers(activeFileNumbers) {

      jQuery(".loader").hide();
      activeFileNumbers.forEach(function (activeFileNumber) {
        document.getElementById('activeFileNumbers').innerHTML += createFileNumberElement(activeFileNumber);
      });
    }

    function createFileNumberElement(fileData) {
      return "<div class='activeFileNumber' \nonclick='promptToArchiveFileNumber(this, " +
        fetchArgumentFromUrlString("patient_id") + ")'id=" + fileData.identifier + " " + fileData.family_name +
        "'><h3>" + fileData.given_name + " " + fileData.family_name +
        "</h3><hr width='100%'/><p>File Number:&nbsp;&nbsp;" + fileData.identifier +
        "<br />Date Started:&nbsp;&nbsp;" + fileData.start_date +
        "<br />Last Visit:&nbsp;&nbsp;" + new moment(fileData.appointment_date).format('MM-DD-YYYY') +
        "<br />State:&nbsp;&nbsp;" + fileData.state + "<br /></p></div>";
    }

    function fetchArchivingCandidates() {

      jQuery(".loader").show();
      GET({
        url: apiUrl + '/archiving_candidates',
        async: true,
        headers: {
          'Authorization': sessionStorage.getItem('authorization')
        }
      }, {
        page: paginationPage,
        page_size: PAGE_SIZE
      }, function (data) {
        addNextButton();
        if (paginationPage > 0) {
          addPrevButton();
        } else if (paginationPage === 0 && document.getElementById('previousButton') && document.getElementById(
            'previousButton').style.display === 'block') {
          document.getElementById('previousButton').style.display = 'none';
        }
        populatePageWithActiveFileNumbers(data);
      }, function (error) {
        console.error(error);
      });
    }

    function promptToArchiveFileNumber(event, patientId) {
      showPrompt({
        message: "Are you sure want to archive the patient with file number " + event.id + "?",
        yesCallback: function yesCallback() {
          removePrompt();
          archiveFileNumber(event, patientId);
        },
        noCallback: removePrompt
      });
    }

    function archiveFileNumber(event, patientId) {
      POST({
        url: apiUrl + '/patients/' + patientId + '/filing_number',
        async: true,
        headers: {
          'Authorization': sessionStorage.getItem('authorization'),
          'Content-Type': 'application/x-www-form-urlencoded'
        }
      }, {
        filing_number: event.id
      }, function (data) {
        //set patient ids to be used in printing file numbers on next page
        sessionStorage.newPatientID = data.new_identifier.patient_id;
        sessionStorage.oldPatientID = data.archived_identifier.patient_id;
        redirectToUrl('/apps/ART/views/assigned_patient_file_number.html?old=' + data.archived_identifier.identifier +
          '&new=' + data.new_identifier.identifier);
      }, function (error) {
        console.error(error);
        showMessage('There was a problem reassigning the file number.');
      });
    }

    function fetchArgumentFromUrlString(argumentName) {
      var url = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : location.href;

      var urlToSearch = new URL(url);
      var argument = urlToSearch.searchParams.get(argumentName);
      return argument;
    }

    function fetchFileNumber(patientId) {
      POST({
        url: apiUrl + '/patients/' + patientId + '/filing_number',
        async: true,
        headers: {
          'Authorization': sessionStorage.getItem('authorization'),
          'Content-Type': 'application/json'
        }
      }, {}, function (data, status) {
        if (status === 201) {
          createPatientFilingNumber(patientId, data.new_identifier.identifier);
        } else {
          showMessage('No available active file numbers. Please archive a dormant one from the following list.');
          setTimeout(function () {
            fetchArchivingCandidates();
          }, 3000);
        }
      }, function (error) {
        console.error(error);
        showMessage('An error occured while fetching the patient\'s file number.');
      });
    }

    function redirectToUrl(url) {
      document.location = url
    }

    function createPatientFilingNumber(patientId, filingNumber) {
      POST({
        url: apiUrl + '/patients/' + patientId + '/filing_number',
        async: true,
        headers: {
          'Authorization': sessionStorage.getItem('authorization'),
          'Content-Type': 'application/x-www-form-urlencoded'
        }
      }, {
        filing_number: filingNumber
      }, function (data) {
        sessionStorage.newPatientID = patientId;
        redirectToUrl("/apps/ART/views/assigned_patient_file_number.html?new=" + data.new_identifier.identifier);
      }, function (error) {
        console.error(error);
        showMessage('An error occured while creating the patient\'s file number.');
      });
    }

    function POST(config) {
      var data = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
      var successCallback = arguments[2];
      var failureCallback = arguments[3];

      var request = window.XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject('Microsoft.XMLHTTP');

      request.onreadystatechange = function () {
        if (request.readyState === 4 && request.status === 201) {
          successCallback(JSON.parse(request.responseText), request.status);
        } else if (request.readyState === 4 && request.status === 204) {
          successCallback({}, request.status);
        } else if (request.readyState === 4 && request.status >= 400) {
          failureCallback(request.responseText, request.status);
        }
      };

      request.open('POST', config.url, config.async);

      Object.keys(config.headers).forEach(function (key) {
        request.setRequestHeader(key, config.headers[key]);
      });

      request.send(encodeURI(buildParametersString(data)));
    }

    function GET(config) {
      var data = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
      var successCallback = arguments[2];
      var failureCallback = arguments[3];

      var request = window.XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject('Microsoft.XMLHTTP');

      request.onreadystatechange = function () {
        if (request.readyState === 4 && request.status === 200) {
          successCallback(JSON.parse(request.responseText), request.status);
        } else if (request.readyState === 4 && request.status >= 400) {
          failureCallback(request.responseText, request.status);
        }
      };

      request.open('GET', config.url + ('?' + encodeURI(buildParametersString(data))), config.async);

      Object.keys(config.headers).forEach(function (key) {
        request.setRequestHeader(key, config.headers[key]);
      });

      request.send();
    }

    function buildParametersString(params) {
      var paramsString = '';
      Object.keys(params).forEach(function (key, index, array) {
        paramsString += key + '=' + params[key];
        if (index < array.length - 1) {
          paramsString += '&';
        }
      });
      return paramsString;
    }

    function clearActiveFileNumbersDiv() {
      document.getElementById('activeFileNumbers').innerHTML = ''
    }

    function addNextButton() {
      var nextButton = document.getElementById('nextButton')
      nextButton.innerHTML = '<span>Next List</span>'
      nextButton.setAttribute('onmousedown', 'clearActiveFileNumbersDiv(); nextPage(); fetchArchivingCandidates();')
      document.getElementById('nextButton').style.display = 'block'
    }

    function addPrevButton() {
      if (document.getElementById('previousButton') && document.getElementById('previousButton').style.display ===
        'block') {
        return;
      }
      var prevButton = document.createElement('button');
      prevButton.innerHTML = '<span>Previous List</span>';
      prevButton.setAttribute('onmousedown', 'clearActiveFileNumbersDiv(); previousPage(); fetchArchivingCandidates();');
      prevButton.setAttribute('id', 'previousButton');
      prevButton.setAttribute('style', 'display: block;');
      document.getElementById('buttons').appendChild(prevButton);
    }

    function nextPage() {
      paginationPage = paginationPage + 1
    }

    function previousPage() {
      if (paginationPage === 0) {
        return
      }
      paginationPage = paginationPage - 1
    }

    function showPrompt() {
      var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};

      var prompt = document.createElement('div');
      prompt.setAttribute('id', 'dankPrompt');
      prompt.style =
        'background-color: white;font-size: 1.5em;font-family: Ubuntu;position: fixed;width: 50%;height: auto;top: 25%;left: 25%;padding: 2%;' +
        'border-radius: 4px;z-index: 9000;';

      var promptMessage = document.createElement('h3');
      promptMessage.innerText = options.message;
      promptMessage.innerHTML += '<hr />';
      prompt.appendChild(promptMessage);

      prompt.appendChild(createToolkitButton({
        text: 'Yes',
        listeners: [{
          event: 'click',
          handler: options.yesCallback
        }],
        style: 'color: white; float: left'
      }));

      prompt.appendChild(createToolkitButton({
        text: 'No',
        listeners: [{
          event: 'click',
          handler: options.noCallback
        }],
        style: 'color: white; float: right'
      }));

      document.body.appendChild(createScreenOverlay({
        color: 'black',
        opacity: .8
      }));
      document.body.appendChild(prompt);
    }

    function createScreenOverlay() {
      var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};

      var overlay = document.createElement('div');
      overlay.setAttribute('id', 'dankOverlay');
      overlay.style = 'background-color: ' +
        options.color + ';\nopacity: ' +
        options.opacity + ';position: fixed;width: 100%;height: 100%;top: 0;bottom: 0;left: 0;right: 0;z-index: 9000;';
      return overlay;
    }

    function removePrompt() {
      document.body.removeChild(document.getElementById('dankOverlay'))
      document.body.removeChild(document.getElementById('dankPrompt'))
    }

    function createToolkitButton() {
      var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};

      var button = document.createElement('button');
      button.innerHTML += '<span>' + options.text + '</span>';

      if (options.attributes) {
        options.attributes.forEach(function (attribute) {
          button.setAttribute(attribute.name, attribute.value);
        });
      }

      if (options.listeners) {
        options.listeners.forEach(function (listener) {
          button.addEventListener(listener.event, listener.handler);
        });
      }

      if (options.style) {
        button.style = options.style;
      }

      return button;
    }
  </script>
</body>